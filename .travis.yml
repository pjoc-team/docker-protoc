language: shell
services:
- docker
#stages:
#- name: build
#  if: tag IS blank
#- name: release
#  if: tag IS present


env:
  global:
  - BASE_REPO=$DOCKER_USER/${TRAVIS_REPO_SLUG##*/}
  - DOCKER_TAG=${TRAVIS_COMMIT:0:7}
  - DEV_REPO=${BASE_REPO}:$DOCKER_TAG
  - RELEASE_REPO=${BASE_REPO}:$TRAVIS_TAG
  - LATEST_REPO=${BASE_REPO}:latest

before_install:
- env
- docker login -u$DOCKER_USER -p$DOCKER_PASS
install:
- if [[ -z "$TRAVIS_TAG" ]]; then docker build nginx -t $DEV_REPO && docker push $DEV_REPO; fi # build
- if [[ -n "$TRAVIS_TAG" ]]; then docker pull $DEV_REPO && docker tag $DEV_REPO $RELEASE_REPO && docker tag $DEV_REPO $LATEST_REPO && docker push $RELEASE_REPO && docker push $LATEST_REPO; fi # release

